language: cpp
os: linux
sudo: required
dist: trusty

env:
  global:
    - secure: "QJAeWhifIJMYvriM2qD3KaPCQjzWCnoRRUdW/pNRkGt9OnYxAcRB+SH4bZdRxg/Dj31CRc44jd9aDMhahqAh13tuPR9uhRVnP2NxncUD2EMH4VptHEazrK0zE7nL1W3yiuSwgHT185Jcjta1Xrt4gsOc9J0G8c9WCkvtcUWmxxOrNyq6On17e2dyPsG6j4ZbgJbnOEwYIQbNDKOZ9SBmRtJweBLsb+xk8h4jRRnPOxwKAd1S0IXDkkhWbjx4rb33bJM7TwtGq2MUSygd+fc9cbg5h4Ke9JzXUTe8MfNe8nIjx3luiOkxZM1igIQz5mr3vuwhqtmRi7vznXA78ToQUqEILWmihUkxoqvJf7JfiHI/izItqMuNhZDXToCz0oKAF77uasi4sRTRPsmgA+ttl0rg9QZQrmqjA4UA1O6MtHwBwgNulVz6hsLM2QY89bSmdcT1bd6+Lz5L2vtrYtbZ85C/ObHVXdd9SYwystL7LdWpj1s5rrFdDa0F/SDGmQkmDqsyYLhla/H1T4LldgjcffjMu+Jyr7gzRIHqLHPyzoONuqinueybvtpVOblMHh8mdIGNR4CSAJGizPj2a/TcdomC5KlSTZ3ONZs3F3qo8kcIaPO61Nl4hvEiK7AH7pd6T/4k3EEHeKSPLpWn2d+udGNd5O8q9Tf7RR2sfVqqvpA="

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-4.8
      - cmake
    coverity_scan:
      project:
        name: "Bo-Yuan-Huang/SimpleAPI"
        description: "C++ project template"
      notification_email: byhuang1992@gmail.com
      build_command_prepend: "mkdir -p build; cd build; cmake -Dcoverage=ON .."
      build_command:   "make"
      branch_pattern: coverity_scan

before_install:
  # coverity
  - echo -n | openssl s_client -connect scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-
  - sudo apt-get update -qq

install:
  - gem install coveralls-lcov	
  - sudo apt-get install liblapack-dev libblas-dev libboost-dev libarmadillo-dev
  # install newer LCOV (1.9 was failing)
  #- wget http://ftp.de.debian.org/debian/pool/main/l/lcov/lcov_1.11.orig.tar.gz
  #- tar xf lcov_1.11.orig.tar.gz
  #- sudo make -C lcov-1.11/ install
  - sudo apt-get install lcov

before_script:
  - lcov --version
  - gcov --version
  - g++ --version
  - PARENTDIR=$(pwd)
  - mkdir $PARENTDIR/build && cd $PARENTDIR/build
  - lcov --directory $PARENTDIR/build --zerocounters

script:
  - cd $PARENTDIR/build
  - cmake -Dcoverage=ON -DCMAKE_CXX_COMPILER=$COMPILER $PARENTDIR
  - make
  - make gtest

after_success:
  - lcov --directory $PARENTDIR/build --capture --output-file coverage.info # capture coverage info
  - lcov --remove coverage.info 'tests/*' 'app/*' 'external/*' 'cmake/*' '/usr/*' --output-file coverage.info # filter out system and test code
  - lcov --list coverage.info # debug before upload
  - coveralls-lcov coverage.info #--repo-token _____ coverage.info # uploads to coveralls

notifications:
  email: false
